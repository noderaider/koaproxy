<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/es-http-proxy/common.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/noderaider/koaproxy.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">es-http-proxy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/es-http-proxy/ProxyServer.js~ProxyServer.html">ProxyServer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createRightProxy">createRightProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getPort">getPort</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasEncryptedConnection">hasEncryptedConnection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setupOutgoing">setupOutgoing</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setupSocket">setupSocket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-urlJoin">urlJoin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createProxyServer">createProxyServer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isSSL">isSSL</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">es-http-proxy/passes</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-XHeaders">XHeaders</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deleteLength">deleteLength</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stream">stream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-timeout">timeout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeChunked">removeChunked</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setConnection">setConnection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setRedirectHostRewrite">setRedirectHostRewrite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-writeHeaders">writeHeaders</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-XHeaders">XHeaders</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkMethodAndHeader">checkMethodAndHeader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stream">stream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-writeStatusCode">writeStatusCode</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/es-http-proxy/common.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import url from &apos;url&apos;
import required from &apos;requires-port&apos;

const upgradeHeader = /(^|,)\s*upgrade\s*($|,)/i

/**
 * Simple Regex for testing if protocol is https
 */
export const isSSL = /^https|wss/

/**
 * Copies the right headers from `options` and `req` to
 * `outgoing` which is then used to fire the proxied
 * request.
 *
 * Examples:
 *
 *    setupOutgoing(outgoing, options, req)
 *    // =&gt; { host: ..., hostname: ...}
 *
 * @param {Object} Outgoing Base object to be filled with required properties
 * @param {Object} Options Config object passed to the proxy
 * @param {ClientRequest} Req Request Object
 * @param {String} Forward String to select forward or target
 *&#xA0;
 * @return {Object} Outgoing Object with all required properties set
 *
 * @api private
 */

export function setupOutgoing(outgoing, options, req, forward) {
  outgoing.port = options[forward || &apos;target&apos;].port || (isSSL.test(options[forward || &apos;target&apos;].protocol) ? 443 : 80)

  const outgoingTypes = [ &apos;host&apos;, &apos;hostname&apos;, &apos;socketPath&apos;, &apos;pfx&apos;, &apos;key&apos;, &apos;passphrase&apos;, &apos;cert&apos;, &apos;ca&apos;, &apos;ciphers&apos;, &apos;secureProtocol&apos; ]
  outgoingTypes.forEach(function mapOutgoing(e) {
    outgoing[e] = options[forward || &apos;target&apos;][e]
  })

  outgoing.method = req.method
  outgoing.headers = Object.assign({}, req.headers)

  if (options.headers)
    outgoing.headers = { ...outgoing.headers, ...options.headers }
  if (options.auth)
    outgoing.auth = options.auth
  if (isSSL.test(options[forward || &apos;target&apos;].protocol))
    outgoing.rejectUnauthorized = (typeof options.secure === &apos;undefined&apos;) ? true : options.secure

  outgoing.agent = options.agent || false
  outgoing.localAddress = options.localAddress

  //
  // Remark: If we are false and not upgrading, set the connection: close. This is the right thing to do
  // as node core doesn&apos;t handle this COMPLETELY properly yet.
  //
  if (!outgoing.agent) {
    outgoing.headers = outgoing.headers || {}
    if (typeof outgoing.headers.connection !== &apos;string&apos; || !upgradeHeader.test(outgoing.headers.connection))
      outgoing.headers.connection = &apos;close&apos;
  }


  // the final path is target path + relative path requested by user:
  var target = options[forward || &apos;target&apos;]
  var targetPath = target &amp;&amp; options.prependPath !== false
    ? (target.path || &apos;&apos;)
    : &apos;&apos;

  //
  // Remark: Can we somehow not use url.parse as a perf optimization?
  //
  var outgoingPath = !options.toProxy
    ? (url.parse(req.url).path || &apos;&apos;)
    : req.url

  //
  // Remark: ignorePath will just straight up ignore whatever the request&apos;s
  // path is. This can be labeled as FOOT-GUN material if you do not know what
  // you are doing and are using conflicting options.
  //
  outgoingPath = !options.ignorePath ? outgoingPath : &apos;&apos;

  outgoing.path = urlJoin(targetPath, outgoingPath)

  if (options.changeOrigin) {
    outgoing.headers.host =
      required(outgoing.port, options[forward || &apos;target&apos;].protocol) &amp;&amp; !hasPort(outgoing.host)
        ? outgoing.host + &apos;:&apos; + outgoing.port
        : outgoing.host
  }
  return outgoing
}

/**
 * Set the proper configuration for sockets,
 * set no delay and set keep alive, also set
 * the timeout to 0.
 *
 * Examples:
 *
 *    setupSocket(socket)
 *    // =&gt; Socket
 *
 * @param {Socket} Socket instance to setup
 *&#xA0;
 * @return {Socket} Return the configured socket.
 *
 * @api private
 */

export function setupSocket(socket) {
  socket.setTimeout(0)
  socket.setNoDelay(true)

  socket.setKeepAlive(true, 0)

  return socket
}

/**
 * Get the port number from the host. Or guess it based on the connection type.
 *
 * @param {Request} req Incoming HTTP request.
 *
 * @return {String} The port number.
 *
 * @api private
 */
export function getPort(req) {
  var res = req.headers.host ? req.headers.host.match(/:(\d+)/) : &apos;&apos;

  return res ?
    res[1] :
    hasEncryptedConnection(req) ? &apos;443&apos; : &apos;80&apos;
}

/**
 * Check if the request has an encrypted connection.
 *
 * @param {Request} req Incoming HTTP request.
 *
 * @return {Boolean} Whether the connection is encrypted or not.
 *
 * @api private
 */
export function hasEncryptedConnection(req) {
  return Boolean(req.connection.encrypted || req.connection.pair)
}

/**
 * OS-agnostic join (doesn&apos;t break on URLs like path.join does on Windows)&gt;
 *
 * @return {String} The generated path.
 *
 * @api private
 */

export function urlJoin() {
    //
    // We do not want to mess with the query string. All we want to touch is the path.
    //
  const args = Array.prototype.slice.call(arguments)
  let lastIndex = args.length - 1
  let last = args[lastIndex]
  let lastSegs = last.split(&apos;?&apos;)
  let retSegs

  args[lastIndex] = lastSegs.shift()

  //
  // Join all strings, but remove empty strings so we don&apos;t get extra slashes from
  // joining e.g. [&apos;&apos;, &apos;am&apos;]
  //
  retSegs = [
    args.filter(Boolean).join(&apos;/&apos;)
        .replace(/\/+/g, &apos;/&apos;)
        .replace(&apos;http:/&apos;, &apos;http://&apos;)
        .replace(&apos;https:/&apos;, &apos;https://&apos;)
  ]

  // Only join the query string if it exists so we don&apos;t have trailing a &apos;?&apos;
  // on every request

  // Handle case where there could be multiple ? in the URL.
  retSegs.push.apply(retSegs, lastSegs)

  return retSegs.join(&apos;?&apos;)
}

/**
 * Check the host and see if it potentially has a port in it (keep it simple)
 *
 * @returns {Boolean} Whether we have one or not
 *
 * @api private
 */
function hasPort(host) {
  return !!~host.indexOf(&apos;:&apos;)
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
